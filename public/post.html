<!doctype HTML>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Dot Editor</title>
		<link href="./css/dot_common.css" media="screen" rel="stylesheet" type="text/css" />
		<link href="./css/dot_post.css" media="screen" rel="stylesheet" type="text/css" />
		<link rel="shortcut icon" href="./images/favicon.png" />
		<script src="./js/canvas.js"></script>
		<script src="./js/base64.js"></script>
	</head>
	<body>
		<div id="container">
			<div id="header">
				<h1><a href="/"><img src="./images/dota_32x32.png" /></a></h1>
			</div>
			
<!--			<div contenteditable="true">hogehoge</div>-->
			<p>Twitterへドット絵を投稿します。</p>
			<form action="/auth/twitter/post" method="post" id="post-form">
				
				<div id="image-scale">
					<input type="radio" name="scale" id="scale-1" value="1" checked /><label for="scale-1">等倍</label>
					<input type="radio" name="scale" id="scale-2" value="2" /><label for="scale-2">2倍</label>
					<input type="radio" name="scale" id="scale-3" value="3" /><label for="scale-3">3倍</label>
					<input type="radio" name="scale" id="scale-4" value="4" /><label for="scale-4">4倍</label>
				</div>
				<div>
					<input type="checkbox" id="transparent" /><label for="transparent">背景を透明にする(背景のピクセルをクリック)</label>
				</div>
				<div id="dot-preview"><canvas id="canvas"></canvas></div>
				<p><textarea id="text" name="text">#pixelart http://dot-a.herokuapp.com/</textarea></p>
				<p><span id="text-count">134</span></p>
				<p><img id="loading" src="./images/loading_1.gif" /></p>
				<p><input type="submit" id="post" value="投稿する" /></p>
				<input type="hidden" id="image" name="image" />
			</form>
			<script>
				(function() {
					var canvas = document.getElementById('canvas'),
						ctx = canvas.getContext('2d'),
						text = document.getElementById('text'),
						textCount = document.getElementById('text-count'),
						scale = 1,
						transparent = 256,
						image;
					
					textCount.textContent = '' + (140 - text.value.length);
					
					function render(index, paltte) {
						canvas.width = index.width * scale ^ 0;
						canvas.height = index.height * scale ^ 0;
						drawIndexedImageData(ctx, image.indexData, image.paletteData, scale, transparent);
					}
					
					if(window.opener) {
						window.opener.postMessage('getImage');
						image = window.opener.getImage();
					} else {
						window.location.href = '/';
					}

					window.addEventListener('message', e => {
						image = e.data;
						render(image.indexData, image.paletteData);
					}, false);
					
					document.getElementById('image-scale').addEventListener('change', function(e) {
						if(image && /scale-[1-4]/.test(e.target.getAttribute('id'))) {
							scale = parseInt(e.target.value, 10);
							render(image.indexData, image.paletteData);
						}
					});
					
					document.getElementById('transparent').addEventListener('change', function(e) {
						console.log(e.target.checked);
						transparent = e.target.checked ? 0 : 256;
						render(image.indexData, image.paletteData);
					});
					
					document.getElementById('canvas').addEventListener('click', function(e) {
						if(document.getElementById('transparent').checked) {
							var rect = e.target.getBoundingClientRect(),
								x = (e.pageX - rect.left) / scale ^ 0,
								y = (e.pageY - rect.top) / scale ^ 0;
							transparent = image.indexData.data[y * image.indexData.width + x];
							console.log(x, y, transparent);
							render(image.indexData, image.paletteData);
						}
					});
					
					function strlen(str) {
						return str.length - (str.match(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g)||[]).length;
					}
					
					text.addEventListener('keyup', function(e) {
						textCount.textContent = '' + (140 - strlen(text.value));
					});
					
					document.getElementById('post-form').addEventListener('submit', function(e) {
						var palette = Array.prototype.filter.call(image.paletteData.data, function(e, i) {
							return i % 4 !== 3;
						});
						var json = {
							index: Base64.encode(image.indexData.data),
							palette: Base64.encode(palette),
							width: image.indexData.width,
							height: image.indexData.height,
							transparent: transparent
						};
						
						document.getElementById('post').setAttribute('disabled', '');
						document.getElementById('image').value = JSON.stringify(json);
						document.getElementById('loading').style.display = 'inline';
					}, true);
				})();
			</script>
		<div id="footer">
			<p>動作環境: Windows7, Google Chrome, Firefox, Opera で動作確認</p>
			<p class="copyright">Copyright 2013 <a href="https://twitter.com/sapphire_al2o3">@sapphire_al2o3</a></p>
		</div>
		</div>
	</body>
</html>