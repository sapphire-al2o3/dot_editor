<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<title>Dot Editor Lite</title>
		<link href="./css/dot_common.css" media="screen" rel="stylesheet" type="text/css" />
		<link rel="shortcut icon" href="./images/favicon.png" />
		<script src="./js/base64.js"></script>
		<script src="./js/canvas.js"></script>
		<style>
			p {
				font-size: 12px;
				text-align: center;
				color: #555;
			}
			#close {
				color: #555;
				font-weight: bold;
				margin-bottom: 16px;
				background: none;
				border: 0;
				transition: background-color 0.4s;
				padding: 4px 24px;
				cursor: pointer;
			}
			
			#close:hover {
				background-color: #34c0f4;
				color: #FFF;
			}
			p {
				line-height: 2em;
			}
			canvas {
				border: 1px solid #EEE;
				margin-bottom: 16px;
			}
		</style>
	</head>
	<body>
		<div id="container">
			<div id="header">
				<h1><a href="/"><img src="./images/dota_32x32.png" /></a></h1>
			</div>
			<p><canvas id="canvas" width="256" height="256"></canvas></p>
			<p><a href="" id="encode">URLに変換</a></p>
			<div id="footer">
				<p class="copyright">Copyright 2013 <a href="https://twitter.com/sapphire_al2o3">@sapphire_al2o3</a></p>
			</div>
		</div>
		<script>
			(function() {
				var canvas = document.getElementById('canvas'),
					ctx = canvas.getContext('2d'),
					w = canvas.width,
					h = canvas.height,
					scale = 16;
				
				var image = createIndexData(24, 24);
				
				var hash = location.hash.slice(1);
				
				if(hash) {
					var data = Base64.decode(hash);
					unpack(data, image.data);
				}
				resize(image, scale);
				
				var r, px, py, index = 1;
				
				function mousemove(e) {
					var x = (e.pageX - r.left) / scale ^ 0,
						y = (e.pageY - r.top) / scale ^ 0;
					drawLine(ctx, px, py, x, y, image, index, scale);
					px = x;
					py = y;
					e.preventDefault();
				}
				
				function mouseup(e) {
					document.removeEventListener('mouseup', mouseup);
					document.removeEventListener('mousemove', mousemove);
				}
				
				canvas.addEventListener('mousedown', function(e) {
					r = canvas.getBoundingClientRect();
					px = (e.pageX - r.left) / scale ^ 0;
					py = (e.pageY - r.top) / scale ^ 0;
					index = 1 - image.data[py * image.width + px];
					ctx.fillStyle = index ? '#000' : '#FFF';
					drawDot(ctx, px, py, image, index, scale);
					document.addEventListener('mousemove', mousemove);
					document.addEventListener('mouseup', mouseup);
					e.preventDefault();
				});
				
				function sub(data, p) {
					p = p || [];
					p[0] = data[0];
					for(var i = 1, n = data.length; i < n; i++) {
						p[i] = data[i] - data[i - 1];
					}
					return p;
				}
				
				function pack(data, p) {
					var k = 0;
					p = p || [];
					for(var i = 0, n = data.length / 8 ^ 0; i < n; i++) {
						p[i] = 0;
						for(var j = 0; j < 8; j++) {
							p[i] |= (data[k++] !== 0) << j;
						}
					}
					return p;
				}
				
				function unpack(data, p) {
					var k = 0;
					p = p || [];
					for(var i = 0, n = data.length; i < n; i++) {
						for(var j = 0; j < 8; j++) {
							p[k++] = (data[i] >> j) & 1;
						}
					}
					return p;
				}
				
				function encode(image) {
					var w = image.width,
						h = image.height,
						data = image.data;
					return Base64.encode(data);
				}
				
				function resize(image, scale) {
					canvas.width = scale * image.width;
					canvas.height = scale * image.height;
					render(image, scale);
				}
				
				function render(image, scale) {
					var data = image.data,
						w = image.width,
						h = image.height;
					ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
					ctx.fillStyle = '#000';
					for(var i = 0; i < h; i++) {
						for(var j = 0; j < w; j++) {
							if(data[i * w + j]) {
								ctx.fillRect(j * scale, i * scale, scale, scale);
							}
						}
					}
					ctx.fill();
				}
				
				document.getElementById('encode').addEventListener('click', function(e) {
					var data = pack(image.data);
					console.log(data.length);
					console.log(RLE.encode(data).length);
					location.hash = Base64.encode(data);
					e.preventDefault();
				});
				
				var dota = {
					clear: clear.bind(null, ctx, image),
					resize: resize.bind(null, image),
					flipH: function() {
//						ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
						flipH(ctx, image);
						render(image, scale);
					}
				};
				
				this.dota = dota;
			})();
		</script>
	</body>
</html>